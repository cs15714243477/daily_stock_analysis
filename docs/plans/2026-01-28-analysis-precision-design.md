# Design: Improve Analysis Precision (Swing 1–4 Weeks)

Date: 2026-01-28  
Scope: A股/港股/美股的“波段 1–4 周”分析更精准（可量化提升），优先技术面与回测校准。

## Background

当前系统的技术面核心以 `MA(5/10/20/60)+乖离率+量能(5日均量比)+MACD+RSI+简单支撑压力` 为主，并补充了实时行情字段（量比/换手率/估值/市值）与筹码分布，再通过搜索新闻交由 LLM 汇总。

对“波段 1–4 周”而言，现状存在两个主要限制：

1. **样本长度不足**：历史数据默认 `days=30`，会导致 MA60/趋势强度/波动率/布林带宽等关键特征不稳定（甚至用 MA20 代替 MA60，导致中期过滤失真）。
2. **固定阈值不可泛化**：乖离率 5%、支撑容忍度 2%、缩量/放量阈值等为常数，无法适应不同股票/不同行情的波动率差异，容易产生“看似合理但交易不可用”的假信号。

## Goals

- 在 1–4 周持仓窗口内，提升信号的可交易性：更高期望值、更低回撤、更少噪声洗出。
- 将关键阈值从“拍脑袋常数”升级为“可回测校准+可配置+可解释”的参数体系。
- 引入与现有信号正交的关键因子：波动率/趋势强度/通道结构/相对强弱。

## Non-goals

- 不追求短线（1–3天）超高频优化。
- 暂不在本阶段深做消息面事件抽取与来源分级（后续迭代）。
- 不引入高成本付费数据源（保持当前免费/低成本优先）。

## Proposed Changes

### 1) Extend Daily History Window

新增配置项（环境变量 + `src/config.py`）：

- `HIST_DAYS`（默认建议 260）：单股日线拉取长度（至少 1 年交易日）
- `BENCHMARK_CODE`（默认 `000300`）：用于相对强弱 RS 的基准（沪深300）

并将 `src/core/pipeline.py` 里日线获取 `days=30` 改为使用 `HIST_DAYS`，以保证后续 ATR/ADX/BOLL/RS 与 MA60 的稳定性。

### 2) Add Feature Engineering Layer (ATR/ADX/BOLL/RS)

建立统一“特征计算层”，避免指标在多个模块重复实现或口径不一。

核心新增指标：

- `ATR(14)`：用于止损宽度、回踩距离、仓位（风险归一化），降低被噪声洗出概率。
- `ADX(14)`：趋势强度判断（趋势/震荡切换），显著减少震荡期追突破的误报。
- `BOLL(20,2)`：上/中/下轨 + `bandwidth`（收敛/扩张），用于突破质量与震荡收敛识别。
- `RS`（Relative Strength）：个股 vs 基准（沪深300或行业指数）的相对强弱，用于过滤“弱股反弹”。

输出：在分析上下文中提供结构化字段（给 LLM 与策略模块同时使用），例如：

- `indicators.atr_14`
- `indicators.adx_14`
- `indicators.boll.upper/mid/lower/bandwidth`
- `indicators.rs_20/rs_60`（不同周期的相对强弱）

### 3) Regime Switch + Dual Entry Templates

先判断市场状态（Regime），再选择入场模板：

- 趋势市：ADX 高于阈值且中期均线不走平 → 优先回踩买入 + 允许突破买入
- 震荡市：ADX 低于阈值且 BOLL bandwidth 低位收敛 → 更严格突破条件/降低仓位/更短持仓
- 过渡态：降低置信度，提升确认条件

两套入场模板：

- 回踩买入：回踩 MA10/MA20（距离用 `ATR` 动态化），缩量更优，RS 为正
- 突破买入：突破上轨/前高 + bandwidth 扩张 + ADX 上行 + RS 为正

### 4) Backtest + Threshold Calibration

新增回测与参数校准工具，目标是将以下关键阈值“按数据校准”：

- ADX 的趋势/震荡分界（常见候选区间 18–28，需按标的/市场环境回测）
- ATR 止损倍数 `k`（决定最大回撤与胜率/盈亏比的平衡）
- 回踩距离（以 ATR 表达）
- BOLL bandwidth 的分位阈值（收敛/扩张）

回测要求：

- 无未来函数：`t` 日收盘生成信号，`t+1` 执行（开盘/均价），止盈止损按 `high/low` 触发顺序计算。
- 评估指标：胜率、盈亏比、期望值、最大回撤、先止盈/先止损比例、平均持仓天数（贴合 1–4 周）。
- Walk-forward：滚动训练/验证（如 12m 校准 + 3m 验证）降低过拟合。

## Data Requirements

- 单股：至少 260 个交易日 OHLCV（日线）。
- 基准：同周期 OHLC（日线），用于 RS。
- 可选：行业指数（用于更细粒度 RS），后续迭代。

## Rollout Plan

1. 增加配置项与历史数据窗口（不影响现有输出结构）。
2. 实现特征层并将指标注入 `context`（LLM 先“可见”新指标）。
3. 增加 Regime + 双模板打分（先并行输出，不直接替换旧建议）。
4. 引入回测工具，校准阈值后再逐步替换默认常量。

## Testing Plan

- 指标单元测试：ATR/ADX/BOLL/RS 计算正确性（边界：数据不足、缺失值）。
- 回测一致性测试：同输入数据重复运行结果一致（确定性）。
- 回归测试：旧输出字段仍存在，新字段可选出现，不破坏通知/LLM解析。

